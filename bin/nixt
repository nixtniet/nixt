#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import pathlib
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from nixt.classes import CLI, Commands, Config, Dict, Kernel, Message, Method
from nixt.classes import Log, Mods, Static, Thread, Utils, Workdir


"defines"


Config.ignore = "rst,web,wsd,udp"
Config.level = "info"
Config.name = "nixt" 
Config.version = 440


expand = Utils.expand


"clients"


class CLI(CLI):

    def raw(self, text):
        print(text.encode('utf-8', 'replace').decode("utf-8"))


class Console(CLI):

    def callback(self, event):
        if not event.text:
            return
        super().callback(event)
        event.wait()

    def poll(self):
        evt = Message()
        evt.text = input("> ")
        evt.kind = "command"
        return evt


"runtime"


class Runtime:

    @staticmethod
    def banner():
        tme = time.ctime(time.time()).replace("  ", " ")
        print("%s %s %s since %s (%s)" % (
                                       Config.name.upper(),
                                       Config.version,
                                       Config.opts.upper(),
                                       tme,
                                       Config.level.upper()
                                      ))
        sys.stdout.flush()

    @staticmethod
    def check(text):
        args = sys.argv[1:]
        for arg in args:
            if not arg.startswith("-"):
                continue
            for char in text:
                if char in arg:
                   return True

        return False

    @staticmethod
    def daemon(verbose=False, nochdir=False):
        pid = os.fork()
        if pid != 0:
            os._exit(0)
        os.setsid()
        pid2 = os.fork()
        if pid2 != 0:
            os._exit(0)
        if not verbose:
            with open('/dev/null', 'r', encoding="utf-8") as sis:
                os.dup2(sis.fileno(), sys.stdin.fileno())
            with open('/dev/null', 'a+', encoding="utf-8") as sos:
                os.dup2(sos.fileno(), sys.stdout.fileno())
            with open('/dev/null', 'a+', encoding="utf-8") as ses:
                os.dup2(ses.fileno(), sys.stderr.fileno())
        if not nochdir:
            os.umask(0)
            os.chdir("/")
        os.nice(10)

    @staticmethod
    def forever():
        while True:
            try:
                time.sleep(0.1)
            except (KeyboardInterrupt, EOFError):
                break

    @staticmethod
    def pidfile(filename):
        if os.path.exists(filename):
            os.unlink(filename)
        path2 = pathlib.Path(filename)
        path2.parent.mkdir(parents=True, exist_ok=True)
        with open(filename, "w", encoding="utf-8") as fds:
            fds.write(str(os.getpid()))


    @staticmethod
    def privileges():
        import getpass
        import pwd
        pwnam2 = pwd.getpwnam(getpass.getuser())
        os.setgid(pwnam2.pw_gid)
        os.setuid(pwnam2.pw_uid)

    @staticmethod
    def wrap(func):
        import termios
        old = None
        try:
            old = termios.tcgetattr(sys.stdin.fileno())
        except termios.error:
            pass
        try:
            Runtime.wrapped(func)
        finally:
            pass
        if old:
            termios.tcsetattr(sys.stdin.fileno(), termios.TCSADRAIN, old)

    @staticmethod
    def wrapped(func):
        try:
            func()
        except (KeyboardInterrupt, EOFError):
            pass


"scripts"


class Scripts:

    TXT = " ".join(sys.argv[1:])

    @staticmethod
    def background():
        daemon(Runtime.check("v"), Runtime.check("m"))
        privileges()
        boot(Scripts.TXT)
        pidfile(Workdir.pidname(Config.name))
        scanner(Cmds.cmd, Cmds.ver)
        init()
        forever()

    @staticmethod
    def console():
        import readline
        banner()
        if check("0"):
            Config.ignore = Mods.list()
        boot(Scripts.TXT)
        scanner(Cmds.cmd, Cmds.ver)
        init("w" in Config.opts)
        csl = Console()
        csl.start()
        forever()

    @staticmethod
    def control():
        if len(sys.argv) == 1:
            return
        boot(Scripts.TXT)
        scanner(*Dict.values(Cmds))
        cli = CLI()
        evt = Message()
        evt.orig = repr(cli)
        evt.text = " ".join(sys.argv[1:])
        evt.type = "command"
        command(evt)
        evt.wait()

    @staticmethod
    def service():
        privileges()
        banner()
        boot(Scripts.TXT)
        pidfile(Workdir.pidname(Config.name))
        scanner(Cmds.cmd, Cmds.ver)
        init()
        forever()


"commands"


class Cmds:

    @staticmethod
    def cmd(event):
        event.reply(",".join(sorted(Commands.names or Commands.cmds)))

    def cpy(event):
        import shutil
        path = os.path.join(
                            Mods.path.rsplit("nixt")[-3],
                            "nixt",
                            "share",
                            "nixt",
                            "examples"
                           ) 
        if not os.path.exists(path):
            event.reply(f"{path} doesn't exist.")
            return
        event.reply(f"using {path}")
        shutil.copytree(path, Workdir.moddir(), dirs_exist_ok=True)
        event.reply("done")

    @staticmethod
    def srv(event):
        import getpass
        name = getpass.getuser()
        event.reply(Static.SYSTEMD % (Config.name.upper(), name, name, name, Config.name))

    @staticmethod
    def ver(event):
        event.reply(f"{Config.name.upper()} {Config.version} {Config.opts}")


"namespace"


expand(Kernel)
expand(Runtime)
expand(Commands, "command")


"runtime"


def main():
    if check('z'):
        Config.debug = True
    if check("c"):
        wrap(Scripts.console)
    elif check("d"):
        Scripts.background()
    elif check("s"):
        wrapped(Scripts.service)
    else:
        wrapped(Scripts.control)


if __name__ == "__main__":
    main()
