#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from nixt.clients import CLI
from nixt.command import Commands, addcmd, command, getcmd
from nixt.kernels import Config, Kernel, forever, init, scanner
from nixt.message import Message
from nixt.methods import parse
from nixt.package import modules
from nixt.statics import SYSTEMD
from nixt.utility import wrapped
from nixt.workdir import Workdir, pidfile, pidname


Config.ignore = "wsd,udp"
Config.level = "info"
Config.name = "nixt" 
Config.version = 440


class CLI(CLI):

    def raw(self, text):
        print(text.encode('utf-8', 'replace').decode("utf-8"))


class Console(CLI):

    def callback(self, event):
        if not event.text:
            return
        super().callback(event)
        event.wait()

    def poll(self):
        evt = Message()
        evt.text = input("> ")
        evt.kind = "command"
        return evt


"runtime"


def banner():
    tme = time.ctime(time.time()).replace("  ", " ")
    print("%s %s since %s (%s)" % (
                                   Config.name.upper(),
                                   Config.version,
                                   tme,
                                   Config.level.upper()
                                  ))
    sys.stdout.flush()


def check(text):
    args = sys.argv[1:]
    for arg in args:
        if not arg.startswith("-"):
            continue
        for char in text:
            if char in arg:
                return True

    return False


def daemon(verbose=False, nochdir=False):
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    pid2 = os.fork()
    if pid2 != 0:
        os._exit(0)
    if not verbose:
        with open('/dev/null', 'r', encoding="utf-8") as sis:
            os.dup2(sis.fileno(), sys.stdin.fileno())
        with open('/dev/null', 'a+', encoding="utf-8") as sos:
            os.dup2(sos.fileno(), sys.stdout.fileno())
        with open('/dev/null', 'a+', encoding="utf-8") as ses:
            os.dup2(ses.fileno(), sys.stderr.fileno())
    if not nochdir:
        os.umask(0)
        os.chdir("/")
    os.nice(10)


def privileges():
    import getpass
    import pwd
    pwnam2 = pwd.getpwnam(getpass.getuser())
    os.setgid(pwnam2.pw_gid)
    os.setuid(pwnam2.pw_uid)


def wrap(func):
    import termios
    old = None
    try:
        old = termios.tcgetattr(sys.stdin.fileno())
    except termios.error:
        pass
    try:
        wrapped(func)
    finally:
        if old:
            termios.tcsetattr(sys.stdin.fileno(), termios.TCSADRAIN, old)


"scripts"


def background():
    daemon(check("v"), check("m"))
    privileges()
    pidfile(pidname(Config.name))
    addcmd(cmd, ver)
    scanner(modules() or "irc,rss")
    init(modules() or "irc,rss")
    forever()


def console():
    import readline
    banner()
    parse(Config, " ".join(sys.argv[1:]))
    if "a" in Config.opts:
        Config.init = modules()
    else:
        Config.init = Config.sets.init or Config.init
    scanner(Config.init)
    addcmd(cmd, ver)
    init(Config.init, "w" in Config.opts)
    csl = Console()
    csl.start()
    forever()


def control():
    if len(sys.argv) == 1:
        return
    scanner(modules())
    addcmd(cmd, srv, ver)
    csl = CLI()
    csl.silent = False
    evt = Message()
    evt.orig = repr(csl)
    evt.text = " ".join(sys.argv[1:])
    evt.type = "command"
    command(evt)
    evt.wait()


def service():
    privileges()
    pidfile(pidname(Config.name))
    scanner(Config.init or "irc,rss")
    init(Config.init or "irc,rss")
    forever()


"commands"


def cmd(event):
    event.reply(",".join(sorted(Commands.names or Commands.cmds)))

def srv(event):
    name = getpass.getuser()
    event.reply(SYSTEMD % (Config.name.upper(), name, name, name, Config.name))

def ver(event):
    event.reply(f"{Config.name.upper()} {Config.version}")


"runtime"


def main():
    Kernel.configure(check("m"), check("n"))
    if check("b"):
        threading.excepthook = threadhook
    if check('z'):
        Config.debug = True
    if check("c"):
        wrap(console)
    elif check("d"):
        background()
    elif check("s"):
        wrapped(service)
    else:
        wrapped(control)


if __name__ == "__main__":
    main()
