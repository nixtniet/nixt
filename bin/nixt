#!/usr/bin/env python3
# This file is placed in the Public Domain.


"main program"


import os
import sys
import time


sys.path.insert(0, os.getcwd())


from nixt.defines import SYSTEMD, CLI, Commands, Config, Message, Mods
from nixt.defines import adddir, boot, check, command, daemon, enable
from nixt.defines import forever, init, moddir, modules, pidfile, pidname
from nixt.defines import pkgdir, privileges, scanner, wrap, wrapped


"config"


Config.ignore = ""
Config.level = "info"
Config.name = "nixt" 
Config.opts = ""
Config.txt = " ".join(sys.argv[1:])
Config.version = 151


"clients"


class Line(CLI):

    def raw(self, text):
        "write to console."
        print(text.encode('utf-8', 'replace').decode("utf-8"))


class Console(Line):

    def callback(self, event):
        "wait for callback result."
        if not event.text:
            return
        super().callback(event)
        event.wait()

    def poll(self):
        "poll for inpput."
        evt = Message()
        evt.text = input("> ")
        evt.kind = "command"
        return evt


def banner():
    "hello"
    tme = time.ctime(time.time()).replace("  ", " ")
    print("%s %s %s since %s (%s)" % (
        Config.name.upper(),
        Config.version,
        Config.opts.strip().upper(),
        tme,
        Config.level.upper()
    ))
    sys.stdout.flush()


def configure():
    path = os.path.expanduser(f"~/.local/share/pipx/venvs/{Config.name}/share/{Config.name}/examples/")
    if os.path.exists(path):
        adddir(f"{Config.name}.modules", path)
    path = moddir()
    if os.path.exists(path):
        adddir("modules", path)
    if "m" in Config.opts:
        if os.path.exists("examples"):
            adddir("mods", "examples")
        elif os.path.exists("mods"):
            adddir("mods", "mods")


"scripts"


def background():
    "background script."
    daemon(check("v"), check("m"))
    privileges()
    boot(Config)
    pidfile(pidname(Config.name))
    enable(cmd, mod, ver)
    scanner(modules())
    init(modules())
    forever()


def console():
    "console script."
    import readline
    readline.redisplay()
    boot(Config)
    if "v" in Config.opts:
        banner()
    scanner()
    enable(cmd, mod, ver)
    if "a" in Config.opts:
        mds = modules()
    else:
        mds = Config.sets.init
    init(mds, "w" in Config.opts)
    csl = Console()
    csl.start()
    forever()


def control():
    "cli script."
    if len(sys.argv) == 1:
        return
    boot(Config)
    scanner()
    enable(cmd, mod, srv, ver)
    cli = Line()
    evt = Message()
    evt.orig = repr(cli)
    evt.text = " ".join(sys.argv[1:])
    evt.type = "command"
    command(evt)
    evt.wait()


def service():
    "service script."
    privileges()
    boot(Config)
    banner()
    pidfile(pidname(Config.name))
    enable(cmd, mod, ver)
    scanner()
    init(modules())
    forever()


"commands"


def cmd(event):
    "list available commands."
    event.reply(",".join(sorted(Commands.names or Commands.cmds)))


def mod(event):
    "list available commands."
    event.reply(modules())


def srv(event):
    "generate systemd service file."
    import getpass
    name = getpass.getuser()
    event.reply(SYSTEMD % (Config.name.upper(), name, name, name, Config.name))


def ver(event):
    "show version."
    event.reply(f"{Config.name.upper()} {Config.version} {Config.opts}")


"runtime"


def main():
    "runtime."
    configure()
    if check('z'):
        Config.debug = True
    if check("c"):
        wrap(console)
    elif check("d"):
        background()
    elif check("s"):
        wrapped(service)
    else:
        wrapped(control)


if __name__ == "__main__":
    main()
