#!/usr/bin/env python3
# This file is placed in the Public Domain.


import logging
import os
import queue
import shutil
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from nixt.clients import Client
from nixt.command import command, parse, scan
from nixt.configs import Config
from nixt.message import Message
from nixt.outputs import Output
from nixt.package import Mods, getmod, modules
from nixt.threads import launch, threadhook
from nixt.utility import elapsed
from nixt.workdir import Workdir


Config.name = "nixt"
Config.version = 434


Mods.init(local=True)
Workdir.wdr = ".test"


events = queue.Queue()


class CLI(Output):

    def __init__(self):
        Output.__init__(self)
        self.register("command", command)

    def raw(self, txt):
        if "v" in Config.opts:
            print(txt)


class Pool:

    clients: list[Client] = []
    lock = threading.RLock()
    nrcpu = 1
    nrlast = 0

    @staticmethod
    def add(client):
        Pool.clients.append(client)

    @staticmethod
    def init(clz, nr):
        Pool.nrcpu = nr
        for _x in range(Pool.nrcpu):
            clt = clz()
            clt.start()
            Pool.add(clt)

    @staticmethod
    def put(event):
        with Pool.lock:
            if Pool.nrlast >= Pool.nrcpu-1:
                Pool.nrlast = 0
            clt = Pool.clients[Pool.nrlast]
            clt.put(event)
            Pool.nrlast += 1


def banner(name, version):
    tme = time.ctime(time.time()).replace("  ", " ")
    logger = logging.getLogger()
    print("%s %s since %s (%s)" % (
                                   name.upper(),
                                   version,
                                   tme,
                                   logging.getLevelName(logger.getEffectiveLevel())
                                  ))
    sys.stdout.flush()


def consume():
    while True:
        try:
            event = events.get()
            event.wait()
            events.task_done()
        except (KeyboardInterrupt, EOFError):
            os._exit(0)


def payload(todo):
    for cmd, example in todo.items():
        for ex in example:
            evt = Message()
            evt.text = f"{cmd} {ex}"
            evt.kind = "command"
            Pool.put(evt)
            events.put(evt)


def scanner(names=None):
    if names is None:
        names = modules()
    mods = []
    for name in names:
        if name in Mods.ignore:
            continue
        mod = getmod(name)
        if mod:
            mods.append(mod)
            scan(mod)
    return mods


def main():
    if os.path.exists(Workdir.wdr):
        shutil.rmtree(Workdir.wdr)
    parse(Config, " ".join(sys.argv[1:]))
    if "b" in Config.opts:
        threading.excepthook = threadhook
    if "v" in Config.opts:
        banner(Config.name, Config.version)
    scanner()
    if "z" in Config.opts:
        Pool.init(CLI, os.cpu_count())
    else:
        Pool.init(CLI, 1)
    starttime = time.time()
    thrs = []
    NRS = Config.index or 1
    for _x in range(NRS):
        thrs.append(launch(payload, pre))
    for thr in thrs:
        thr.join()
    for _x in range(NRS):
        thrs.append(launch(payload, examples))
    for thr in thrs:
        thr.join()
    for _x in range(NRS):
        thrs.append(launch(payload, post))
    for thr in thrs:
        thr.join()
    launch(consume)
    nrevents = events.qsize()
    events.join()
    endtime = time.time()
    lap = elapsed(endtime-starttime)
    percall = (endtime-starttime)/nrevents
    nrs = events.qsize()
    if "v" in Config.opts:
        print(f"{nrs} events left.")
        print(f"total: {lap} nrs: {nrevents} call: %.6fs" % percall)
    sys.exit()


examples = {
    "cmd": [""],
    "dis": [""],
    "dne": ["", "test2"],
    "dpl": ["hnrss title,url", ""],
    "flt": [""],
    "fnd": ["", "log", "rss", "config", "todo"],
    "log": ["", "test"],
    "man": [""],
    "mod": [""],
    "mre": [""],
    "nme": ["", "hnrss hackernews"],
    "now": [""],
    "pwd": ["", "bla mekker"],
    "req": [""],
    "res": ["", "hnrss"],
    "srv": [""],
    "tdo": ["", "test2", "test3"],
    "thr": [""],
    "upt": [""]
}


pre = {
    "cfg": ["", "nick=mekker"],
    "imp": ["", "testing/feeds.opml"],
    "log": ["", "bla"],
    "rss": ["","http://hnrss.org/newest"],
    "tdo": ["", "mekker"]
}


post = {
    "dne": ["", "hnrss"],
    "exp": [""],
    "rem": ["", "hnrss"]
}


if __name__ == "__main__":
    main()
